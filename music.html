<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8">
		<meta name="referrer" content="no-referrer" />
		<link rel="shortcut icon" href="#"/>
		<link rel="stylesheet" type="text/css" href="css/details.css" />
		<link rel="stylesheet" type="text/css" href="css/music.css" />
		<script src="js/vue.js" type="text/javascript" charset="utf-8"></script>
		<!-- 开发环境版本，包含了有帮助的命令行警告 -->
		<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
		<!--  axios 在线地址 -->
		<script src="https://cdn.bootcdn.net/ajax/libs/axios/0.21.0/axios.min.js"></script>
		<!-- jquery -->
		<script src="js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8"></script>
		<!-- jQuery Cookie 插件在线地址用于方便获取cookie的值 -->
		<script src="https://cdn.staticfile.org/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
		<title>在线音乐播放</title>
	</head>
	<body>
		<div id="biBox">
			<!-- 导航栏 -->
			<div id="banner">
				<!-- 网站logon -->
				<div id="logo">
					<img src="img/diylogo1.png">
				</div>
				<!-- 导航栏左边标题 -->
				<div id="title">
					<ul>
						<a href="javascript:void(0);" v-for="(item,index) in navigationBar" @click="changeStyle(index)" :style="index==setIndex?navigationBarStyle:''"
						 v-text="item">首页</a>
					</ul>
				</div>
				<!-- 导航栏右边标题 -->
				<div id="titleRight">
					<select @click="doSelect($event)" v-if='isGetName!="登录"'>
						<option value="设置" style="display: none;"></option>
						<option value="个人中心">个人中心</option>
						<option value="后台管理">后台管理</option>
						<option value="退出登录">退出登录</option>
					</select>
					<a href="login.html" @click.prevent="isLogged($event)" target="_blank" v-text="isGetName" title="登录">登录</a>
				</div>

			</div>
			<div id="list-biBox"  @click.self="hide()">
				<div id="mainContent">
					<div id="music-main">
						<div id="music-head">
							<marquee width="200px" behavior="scroll" scrollamount="6">
								<strong v-text="showPlay">正在播放</strong>
								</marquee>
							<img src="img/search.png" @click.enter="musicSearch()">
							<input type="text" ref="focus" placeholder="输入关键字|歌手|歌曲|按下Enter搜索" v-model="key_name" @keyup.enter="musicSearch()" />
						</div>
						<div id="music-mid">
							<table border="0" cellspacing="0" cellpadding="10px" width="100%">
								<tr>
									<th>音乐标题</th>
									<th>歌手</th>
									<th>专辑</th>
									<th>时长</th>
								</tr>
								<tr v-for="(itme,index) in musicList" :style="index%2==0?tableStyle:tableStyles">
									<td v-cloak>{{index+1}}.{{itme.name}}<img class="playImg" src="img/play.png" @click="musicPlay(itme.id,itme.name)" /></td>
									<td v-cloak>{{itme.artists[0].name}}</td>
									<td v-cloak>{{itme.album.name}}<img :style="itme.mvid==0?MvIsvisible:playImg" src="img/MV.png" @click="playMv(itme.mvid,itme.name)" /></td>
									<td v-cloak>{{itme.duration | changeMinuteSecond}}</td>
								</tr>

								<tr>
									<td colspan="2" style="text-align: center;" @click="backPage()"><label>上一页</label></td>
									<td colspan="2" style="text-align: center;" @click="nextPage()"><label>下一页</label></td>
								</tr>
							</table>
						</div>
						<div id="music-footer">
							<audio :src="musicUrl" id="music" controls="controls" autoplay="autoplay" loop="loop"></audio>
						</div>

						<video :src="musicMv" id="video"  autoplay="autoplay" controls="controls" :style="videoIsPlay==true?videoMvShow:videoMvOff">
						</video>
						
					</div>
				</div>
			</div>
		</div>
	</body>
	<script type="text/javascript">
		var app = new Vue({
			el: '#biBox',
			data: {
				navigationBarStyle: 'border-bottom: #ffff00 3px solid;color:white',
				isGetName: '登录',
				setIndex: 2,
				hotSetIndedx: 0,
				navigationBar: ['首页', '选影', '音乐', '关于'],
				//显示是否播放
				showPlay:'',
				name:'',
				//有mv歌曲显示MV图片
				playImg: 'position: relative;width: 25px;height: 25px;display: block;',
				MvIsvisible: 'display:none',
				//控制tr背景背景样式
				tableStyle: 'background-color: #141414;height: 70px;',
				tableStyles: 'height: 70px;',
				//MV视频
				videoIsPlay: false,
				videoMvShow: 'position: absolute;width: 600px;height: 400px;margin-left: 23%;margin-top: 10%;display: block;outline:none',
				videoMvOff: 'position: absolute;width: 600px;height: 400px;margin-left: 23%;margin-top: 10%;display: none;',
				
				key_name: '梁静茹',
				offset: 0,
				//歌曲数组
				musicList: [],
				//音乐链接
				musicUrl: '',
				//音乐MV
				musicMv: '',
			},
			methods: {
				changeStyle(index) {
					//this.setIndex = index;
					if (index == 0) {
						window.location.href = 'index.html';
					}
					if (index == 1) {
						window.location.href = 'choose.html';
					}
					if (index == 3) {
						window.location.href = 'aboutMe.html';
					}
				},
				//用于判断有上方登录按钮时是否跳转登录
				isLogged(e) {
					if (e.currentTarget.innerText == '登录') {
						window.location.href = 'login.html';
					}
				},
				//验证用户是否已经登录
				userVrification: function() {
					axios.get('php/userVrification.php').then(response => {
						if (response.data == false) {
							this.isGetName = '登录';
						} else {
							this.isGetName = response.data;
							console.log(response.data);
						}
					})
				},
				//注销登录
				doSelect(e) {
					if (e.target.value == '退出登录') {
						axios.get('php/logOut.php').then(response => {
							this.userVrification();
						})
					}
					else if(e.target.value =='后台管理'){
						open('backStage/index.html');
					}
				},
				//歌曲搜索
				musicSearch() {
					//获取当前时间戳
					const getNowTime = Date.now();
					axios.get('https://autumnfish.cn/search', {
						params: {
							keywords: this.key_name,
							limit: 15,
							offset: this.offset,
							type: 1,
							t: getNowTime
						}
					}).then(response => {
						console.log(response.data.result.songs);
						if (response.data.result.songs == undefined) {
							this.offset -= 15;
							alert('没有更多啦');
						} else {
							this.musicList = response.data.result.songs;
							this.$refs.focus.focus();//让搜索框获得焦点
						}
					})
				},
				//获取音乐播放连接
				musicPlay(id,name) {
					this.name = name;
					const getNowTime = Date.now();
					axios.get('https://autumnfish.cn/song/url', {
						params: {
							id: id,
							t: getNowTime
						}
					}).then(response => {
						this.musicUrl = response.data.data[0].url;
						if(this.musicUrl != null){this.showPlay =  '正在播放----'+ name;}
					})
				},
				//播放MV
				playMv(mvid,name) {
					this.showPlay =  '正在播放MV----'+ name;
					const getNowTime = Date.now();
					axios.get('https://autumnfish.cn/mv/url?id=' + mvid).then(response => {
						console.log(response.data.data.url);
						this.musicMv = response.data.data.url;
						this.videoIsPlay = true;
						window.location.href = "#music-head";
						//播放Mv时暂定歌曲播放
						let myAudio = document.getElementById('music');
						if(myAudio.paused == false){
							myAudio.pause();
						}
					})
				},
				hide() {
					//隐藏video
					this.videoIsPlay = false;
					//暂定MV播放
					let myVideo = document.getElementById('video');
					myVideo.pause();
					//恢复播放歌曲
					let myAudio = document.getElementById('music');
					if(this.name != ''){
						this.showPlay =  '正在播放----'+ this.name;
						myAudio.play();
					}
					else{this.showPlay = '暂无播放歌曲'}
				},
				//上一页，下一页
				nextPage() {
					this.offset += 15;
					this.musicSearch();
				},
				backPage() {
					if (this.offset != 0) {
						this.offset -= 15;
						this.musicSearch();
					}
				},

			},
			//过滤器
			filters: {
				changeMinuteSecond(duration){
					//把毫秒转换为分和秒
					var min = Math.floor((duration/1000/60) << 0);
					var sec = Math.floor((duration/1000) % 60).toFixed(0);
					return min + ':' + (sec < 10 ? '0' : '') + sec;
				}
			},
			mounted() {
				this.userVrification();
				this.musicSearch();
			}
		})
	</script>
</html>
